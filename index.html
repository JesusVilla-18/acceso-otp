<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Acceso con correo OTP</title>
<style>
body { font-family: Arial; margin: 40px; }
input, button { display:block; margin:10px 0; padding:8px; }
#mensaje {
  margin-top:20px;
  background:#f2f2f2;
  padding:10px;
  border: 1px solid #ccc;
  white-space: pre-line;
}
</style>
</head>
<body>

<h2>Acceso con c√≥digo por correo</h2>

<input id="telefono" placeholder="Escribe tu celular (10 d√≠gitos)">
<button onclick="enviarCodigo()">Enviar c√≥digo por correo</button>

<br>

<input id="codigo" placeholder="Escribe el c√≥digo recibido">
<button onclick="verificarCodigo()">Verificar</button>

<p id="mensaje"></p>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxXpztFC6MvQHk2Bh--7hpLqiHf-FYkN5OqxQGj1huM71PnNvbOxRMLxVZzAfaKV0P7KA/exec";

// ===== JSONP =====
function jsonp(url){
  return new Promise((resolve, reject)=>{
    window.callback = resolve;

    const s = document.createElement("script");
    s.src = url + "&callback=callback";
    s.onerror = ()=>reject("Error al conectar con Apps Script");
    document.body.appendChild(s);
  });
}

async function enviarCodigo(){
  let tel = document.getElementById("telefono").value.trim();

  if (tel.length !== 10 || isNaN(tel)) {
    document.getElementById("mensaje").innerText =
      "‚ùå Escribe 10 d√≠gitos v√°lidos.";
    return;
  }

  const numeroSheet = "52" + tel;

  document.getElementById("mensaje").innerText =
    "üì® Enviando c√≥digo por correo...";

  const data = await jsonp(
    `${APPS_SCRIPT_URL}?cel=${numeroSheet}&accion=enviar`
  );

  if (data.existe) {
    document.getElementById("mensaje").innerText =
      "‚úÖ C√≥digo enviado. Revisa tu correo (vence en 2 min).";
  } else {
    document.getElementById("mensaje").innerText =
      "‚ùå Tu n√∫mero no est√° autorizado.";
  }
}

async function verificarCodigo(){
  let tel = document.getElementById("telefono").value.trim();
  let codigo = document.getElementById("codigo").value.trim();

  const numeroSheet = "52" + tel;

  document.getElementById("mensaje").innerText =
    "üîÑ Verificando c√≥digo...";

  const data = await jsonp(
    `${APPS_SCRIPT_URL}?cel=${numeroSheet}&accion=verificar&codigo=${codigo}`
  );

  if (data.valido) {
    document.getElementById("mensaje").innerHTML =
      "‚úÖ C√≥digo correcto.<br><br>" +
      "üîó Tu archivo:<br><b>" + data.link + "</b>";
  } else {
    document.getElementById("mensaje").innerText =
      "‚ùå C√≥digo incorrecto o vencido.";
  }
}
</script>

</body>
</html>
