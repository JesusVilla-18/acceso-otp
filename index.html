<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Acceso OTP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ===== Estilos generales ===== */
body { 
  font-family: Arial, sans-serif; 
  margin: 20px; 
  padding: 0; 
}

.container {
  max-width: 400px;  /* Contenedor centrado y con ancho limitado */
  margin: auto;
}

/* ===== Inputs y botones ===== */
input, button { 
  display: block; 
  width: 100%;      
  margin: 10px 0; 
  padding: 12px;    
  font-size: 16px;  
  box-sizing: border-box; 
  border-radius: 6px;
  border: 1px solid #ccc;
}

button {
  background-color: #007bff;
  color: white;
  cursor: pointer;
  border: none;
}

button:disabled {
  background-color: #aaa;
  cursor: not-allowed;
}

/* ===== Log de mensajes ===== */
#mensaje { 
  margin-top: 20px; 
  white-space: pre-line; 
  padding: 12px; 
  border: 1px solid #ccc; 
  background: #f2f2f2; 
  overflow-wrap: break-word; 
  word-break: break-word;
  border-radius: 6px;
}

#mensaje a {
  color: #007bff;
  text-decoration: none;
  word-break: break-word;
}
</style>
</head>
<body>

<div class="container">
  <h2>Acceso con c√≥digo OTP por correo</h2>

  <input id="email" placeholder="Escribe tu correo">
  <button id="btnEnviar" onclick="enviarCodigo()">Enviar c√≥digo</button>

  <input id="codigo" placeholder="Escribe el c√≥digo recibido" disabled>
  <button id="btnVerificar" onclick="verificarCodigo()" disabled>Verificar</button>

  <p id="mensaje"></p>
</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwB4LqY84fyboA-F-XvPGAcULplruxRDT6s7ucriDW7hoLV2Q13DVxzb8COeYk-YK8hOw/exec";
const mensaje = document.getElementById("mensaje");

// Habilitar/deshabilitar input y bot√≥n del c√≥digo
function setCodigoEnabled(enabled){
  document.getElementById("codigo").disabled = !enabled;
  document.getElementById("btnVerificar").disabled = !enabled;
  if(!enabled){
    document.getElementById("codigo").value = "";
  }
}

async function enviarCodigo(){
  const email = document.getElementById("email").value.trim();
  if(!email){ 
    mensaje.innerText = "‚ùå Escribe tu correo\n";
    return; 
  }

  // Limpiamos log y mostramos enviando c√≥digo
  mensaje.innerText = "üì§ Enviando c√≥digo por correo...\n";

  try{
    const resp = await fetch(APPS_SCRIPT_URL + "?email=" + encodeURIComponent(email));
    const data = await resp.json();
    if(data.ok){
      mensaje.innerText += "‚úÖ C√≥digo enviado al correo: " + email + "\n";
      setCodigoEnabled(true);
    } else {
      mensaje.innerText += "‚ùå Error: " + data.mensaje + "\n";
      setCodigoEnabled(false);
    }
  } catch(e){
    mensaje.innerText += "‚ùå Error al enviar el c√≥digo: " + e + "\n";
    setCodigoEnabled(false);
  }
}

async function verificarCodigo(){
  const email = document.getElementById("email").value.trim();
  const codigo = document.getElementById("codigo").value.trim();
  if(!email || !codigo){ 
    mensaje.innerText += "‚ùå Completa correo y c√≥digo\n"; 
    return; 
  }

  // Guardamos solo los mensajes previos de env√≠o de correo
  let logPrevio = mensaje.innerText.split("\n").filter(line => line.startsWith("üì§") || line.startsWith("‚úÖ C√≥digo enviado")).join("\n");

  // Mostramos "Verificando c√≥digo..."
  mensaje.innerText = logPrevio + "\nüîÑ Verificando c√≥digo...\n";

  try{
    const resp = await fetch(APPS_SCRIPT_URL, {
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`email=${encodeURIComponent(email)}&codigo=${encodeURIComponent(codigo)}`
    });
    const data = await resp.json();

    if(data.ok){
      // Reemplazamos "Verificando c√≥digo..." por ‚úÖ C√≥digo correcto
      mensaje.innerText = logPrevio + "\n‚úÖ C√≥digo correcto\n";

      // Crear enlace con emoji de ojo y texto
      const a = document.createElement("a");
      a.href = data.link;
      a.target = "_blank";
      a.innerText = "üëÅÔ∏è Ver recibos";
      mensaje.appendChild(a);
      mensaje.appendChild(document.createElement("br"));

      // Limpiar inputs y deshabilitar input/bot√≥n del c√≥digo
      setCodigoEnabled(false);
      document.getElementById("email").value = "";

    } else {
      // Reemplazamos "Verificando c√≥digo..." por ‚ùå C√≥digo incorrecto
      mensaje.innerText = logPrevio + "\n‚ùå " + data.mensaje + "\n";
      // Input y bot√≥n siguen habilitados para reintento
    }
  } catch(e){
    mensaje.innerText = logPrevio + "\n‚ùå Error al verificar el c√≥digo: " + e + "\n";
  }
}

// Al cargar la p√°gina, input y bot√≥n del c√≥digo deshabilitados
setCodigoEnabled(false);
</script>

</body>
</html>
