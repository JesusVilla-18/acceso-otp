<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Acceso con c√≥digo por correo</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    input, button { display:block; margin:10px 0; padding:8px; }
    #mensaje {
      margin-top:20px;
      background:#f2f2f2;
      padding:10px;
      white-space: pre-line;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h2>Acceso con c√≥digo por correo</h2>

<input id="email" placeholder="Escribe tu correo institucional">
<button onclick="enviarCodigo()">Enviar c√≥digo</button>

<br>

<input id="codigo" placeholder="Escribe el c√≥digo recibido">
<button onclick="verificarCodigo()">Verificar</button>

<h3>Registro de sistema:</h3>
<p id="mensaje"></p>

<script>
// ======= URL DE TU APPS SCRIPT =======
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyFve7wgPN4H4FYcExoP83DkiE09LlFbF9VbOjbJoPE9l8pZqow4KlUFuz7e3ri3rNiQg/exec";

let emailGlobal = "";
let codigoGenerado = "";
let expiracion = null;

function log(msg){
  document.getElementById("mensaje").innerText += "\n" + msg;
}

// --- Enviar c√≥digo ---
function enviarCodigo(){
  document.getElementById("mensaje").innerText = "";
  const email = document.getElementById("email").value.trim();

  if(!email.includes("@")){
    log("‚ùå Ingresa un correo v√°lido.");
    return;
  }

  emailGlobal = email;
  log("üì§ Verificando correo y enviando c√≥digo...");

  // Definimos callback para JSONP
  window.callback = function(data){
    if(!data.existe){
      log("‚ùå Correo no autorizado.");
      script.remove();
      return;
    }

    // Generar c√≥digo de 6 d√≠gitos
    codigoGenerado = Math.floor(100000 + Math.random()*900000).toString();
    expiracion = Date.now() + 2*60*1000; // 2 minutos

    // Llamada para enviar correo
    const correoScript = document.createElement("script");
    correoScript.src = `${APPS_SCRIPT_URL}?email=${encodeURIComponent(emailGlobal)}&codigo=${codigoGenerado}&callback=callbackCorreo`;
    document.body.appendChild(correoScript);
    script.remove();
  }

  // Callback para env√≠o de correo
  window.callbackCorreo = function(data){
    if(data.ok){
      log("‚úÖ C√≥digo enviado por correo. Expira en 2 minutos.");
    } else {
      log("‚ùå Error al enviar correo.");
    }
    // Eliminamos el script
    scriptCorreo.remove();
  }

  const script = document.createElement("script");
  script.src = `${APPS_SCRIPT_URL}?email=${encodeURIComponent(email)}&callback=callback`;
  document.body.appendChild(script);
  const scriptCorreo = script; // referencia para callbackCorreo
}

// --- Verificar c√≥digo ---
function verificarCodigo(){
  const codigoIngresado = document.getElementById("codigo").value.trim();
  if(!codigoGenerado){
    log("‚ùå Primero solicita un c√≥digo.");
    return;
  }
  if(Date.now() > expiracion){
    log("‚ùå El c√≥digo ha expirado. Solicita uno nuevo.");
    codigoGenerado = "";
    return;
  }
  if(codigoIngresado === codigoGenerado){
    log("‚úÖ C√≥digo correcto. Acceso permitido.");
    log("üîó Aqu√≠ tu enlace: https://drive.google.com/tu-archivo");
  } else {
    log("‚ùå C√≥digo incorrecto.");
  }
}
</script>

</body>
</html>
