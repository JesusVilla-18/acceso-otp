<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Acceso con OTP - Prueba</title>

  <style>
    body { font-family: Arial; margin: 40px; }
    input, button { display:block; margin:10px 0; padding:8px; }
    #mensaje {
      margin-top:20px;
      background:#f2f2f2;
      padding:10px;
      white-space: pre-line;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h2>Acceso con c√≥digo SMS (Prueba)</h2>

<input id="telefono" placeholder="Escribe tu celular (10 d√≠gitos)">
<button id="enviarCodigo" onclick="enviarCodigo()">Enviar c√≥digo</button>

<br>

<input id="codigo" placeholder="Escribe el c√≥digo recibido">
<button onclick="verificarCodigo()">Verificar</button>

<h3>Registro de sistema:</h3>
<p id="mensaje"></p>

<script>
// ======= TU APPS SCRIPT =======
const APPS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbykxvJV31sMMXXF_NoxqVLqqAXtk3KVbyP0zsNogi3KedFQK3hF0EWg312t2AiWC-Qymg/exec";

// ======= VARIABLES =======
let confirmationResult;
let telefonoGlobal = "";

// Logs en pantalla
function log(msg){
  document.getElementById("mensaje").innerText += "\n" + msg;
}

// Consulta tu Sheet
async function consultarSheets(numero){
  const url = `${APPS_SCRIPT_URL}?cel=${numero}`;

  log("üîó URL enviada:");
  log(url);

  try {
    const resp = await fetch(url);
    const texto = await resp.text();

    log("üì• RESPUESTA CRUDA:");
    log(texto);

    const data = JSON.parse(texto);
    log("‚úÖ JSON interpretado:");
    log(JSON.stringify(data, null, 2));

    return data;
  } catch(e){
    log("‚ùå ERROR al consultar Apps Script:");
    log(e.toString());
    return { existe: false };
  }
}

// Enviar c√≥digo (simulado para n√∫mero de prueba)
async function enviarCodigo() {
  document.getElementById("mensaje").innerText = "";

  let tel = document.getElementById("telefono").value.trim();

  if(tel.length !== 10 || isNaN(tel)){
    log("‚ùå Escribe 10 d√≠gitos v√°lidos.");
    return;
  }

  telefonoGlobal = "+52" + tel;
  const numeroParaSheet = "52" + tel;

  log("üìû Tel√©fono escrito: " + tel);
  log("‚û°Ô∏è Para Sheets: " + numeroParaSheet);

  log("üîÑ Consultando Apps Script...");
  const data = await consultarSheets(numeroParaSheet);

  if(!data.existe){
    log("‚ö†Ô∏è Resultado final: NO AUTORIZADO");
    return;
  }

  log("‚úÖ AUTORIZADO");

  // N√∫mero de prueba
  if(telefonoGlobal === "+525540013399"){
    log("‚ÑπÔ∏è N√∫mero de prueba detectado ‚Äî c√≥digo de prueba: 123456");
    confirmationResult = {
      confirm: async function(codigo){
        if(codigo === "123456") return true;
        else throw new Error("C√≥digo incorrecto");
      }
    };
    log("‚úÖ C√≥digo de prueba listo para verificar.");
    return;
  }

  // Aqu√≠ se pondr√≠a el env√≠o real por Firebase (requiere facturaci√≥n)
  log("‚ö†Ô∏è Para n√∫meros reales se requiere Firebase con facturaci√≥n.");
}

// Verificar c√≥digo
async function verificarCodigo() {
  let codigo = document.getElementById("codigo").value.trim();

  if(!confirmationResult){
    log("‚ùå Primero solicita el c√≥digo.");
    return;
  }

  try {
    await confirmationResult.confirm(codigo);
    log("‚úÖ C√≥digo correcto.");

    const telParaSheet = telefonoGlobal.replace("+", "");
    log("üîÅ Reconsultando Sheets con: " + telParaSheet);

    const data = await consultarSheets(telParaSheet);

    if(!data.existe){
      log("‚ùå N√∫mero no autorizado.");
      return;
    }

    log("üîó Link obtenido: " + data.link);
    log("‚úÖ Acceso completo.");
  } catch(e){
    log("‚ùå C√≥digo incorrecto.");
  }
}
</script>

</body>
</html>
