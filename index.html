<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Acceso con OTP</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    body { font-family: Arial; margin: 40px; }
    input, button { display:block; margin:10px 0; padding:8px; }
    #mensaje {
      margin-top:20px;
      background:#f2f2f2;
      padding:10px;
      white-space: pre-line;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h2>Acceso con cÃ³digo SMS</h2>

<input id="telefono" placeholder="Escribe tu celular (10 dÃ­gitos)">
<button id="enviarCodigo" onclick="enviarCodigo()">Enviar cÃ³digo</button>

<br>

<input id="codigo" placeholder="Escribe el cÃ³digo recibido">
<button onclick="verificarCodigo()">Verificar</button>

<h3>Registro de sistema:</h3>
<p id="mensaje"></p>

<script>
// ======= FIREBASE =======
const firebaseConfig = {
  apiKey: "AIzaSyCDpJfISRnxCJiG1PERbYDJ3jQdzxKvIlQ",
  authDomain: "acceso-drive-otp.firebaseapp.com",
  projectId: "acceso-drive-otp",
  storageBucket: "acceso-drive-otp.firebasestorage.app",
  messagingSenderId: "175952295726",
  appId: "1:175952295726:web:1e20d679ae42a0106a6cbf",
  measurementId: "G-49P3MFSGC1"
};

firebase.initializeApp(firebaseConfig);

// ======= TU APPS SCRIPT (EL QUE FUNCIONA) =======
const APPS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbwUfoXe3Dv0HzBsGArXPWPyWdL0NFC_PrWo_DqfdXjQT25UxLsPqCHmATtIMc74WOSN/exec";

window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('enviarCodigo', {
  'size': 'invisible'
});

let confirmationResult;
let telefonoGlobal = "";

function log(msg){
  document.getElementById("mensaje").innerText += "\n" + msg;
}

async function consultarSheets(numero){
  const url = `${APPS_SCRIPT_URL}?cel=${numero}`;

  log("ðŸ”— URL enviada:");
  log(url);

  const resp = await fetch(url);
  const texto = await resp.text();

  log("ðŸ“¥ RESPUESTA CRUDA:");
  log(texto);

  const data = JSON.parse(texto); // <-- aquÃ­ ya sabemos que SÃ es JSON vÃ¡lido
  log("âœ… JSON interpretado:");
  log(JSON.stringify(data, null, 2));

  return data;
}

async function enviarCodigo() {
  document.getElementById("mensaje").innerText = "";

  let tel = document.getElementById("telefono").value.trim();

  if (tel.length !== 10 || isNaN(tel)) {
    log("âŒ Escribe 10 dÃ­gitos vÃ¡lidos.");
    return;
  }

  telefonoGlobal = "+52" + tel;
  const numeroParaSheet = "52" + tel;

  log("ðŸ“ž TelÃ©fono escrito: " + tel);
  log("âž¡ï¸ Para Firebase: " + telefonoGlobal);
  log("âž¡ï¸ Para Sheets: " + numeroParaSheet);

  try {
    log("ðŸ”„ Consultando Apps Script...");

    const data = await consultarSheets(numeroParaSheet);

    if (!data.existe) {
      log("âš ï¸ Resultado final: NO AUTORIZADO");
      return;
    }

    log("âœ… AUTORIZADO â€” enviando SMS...");

    confirmationResult = await firebase.auth()
      .signInWithPhoneNumber(telefonoGlobal, window.recaptchaVerifier);

    log("ðŸ“© CÃ³digo enviado por SMS.");

  } catch (e) {
    console.error(e);
    log("âŒ ERROR REAL DE SISTEMA:");
    log(e.toString());
  }
}

async function verificarCodigo() {
  let codigo = document.getElementById("codigo").value.trim();

  if (!confirmationResult) {
    log("Primero solicita el cÃ³digo.");
    return;
  }

  try {
    await confirmationResult.confirm(codigo);

    const telParaSheet = telefonoGlobal.replace("+", "");

    log("ðŸ” Reconsultando Sheets con: " + telParaSheet);

    const data = await consultarSheets(telParaSheet);

    if (!data.existe) {
      log("âŒ NÃºmero no autorizado.");
      return;
    }

    document.getElementById("mensaje").innerHTML +=
      "\n\nâœ… CÃ³digo correcto.\nðŸ”— Link: " + data.link;

  } catch (error) {
    log("âŒ CÃ³digo incorrecto.");
  }
}
</script>

</body>
</html>
