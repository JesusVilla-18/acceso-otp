<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Acceso con OTP por correo</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    input, button { display:block; margin:10px 0; padding:8px; }
    #mensaje { margin-top:20px; background:#f2f2f2; padding:10px; white-space: pre-line; border: 1px solid #ccc; }
  </style>
</head>
<body>

<h2>Acceso con c√≥digo por correo</h2>

<input id="email" placeholder="Escribe tu correo institucional">
<button onclick="enviarCodigo()">Enviar c√≥digo</button>

<input id="codigo" placeholder="Escribe el c√≥digo recibido">
<button onclick="verificarCodigo()">Verificar c√≥digo</button>

<h3>Registro:</h3>
<p id="mensaje"></p>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTd3IUKTiL6_3krO6DlufJuy6N3a-wO6FSUSdr2u0bQ_PkrWftu0olNwe6m5Ja8So2vw/exec";

function log(msg){
  const p = document.getElementById("mensaje");
  p.innerText += msg + "\n";
}

async function enviarCodigo(){
  document.getElementById("mensaje").innerText = "";
  const email = document.getElementById("email").value.trim();
  if(!email){ log("‚ùå Escribe un correo"); return; }

  log("üì§ Enviando c√≥digo por correo...");

  try{
    await fetch(`${APPS_SCRIPT_URL}?email=${encodeURIComponent(email)}&callback=callback`);
    log("‚úÖ C√≥digo enviado. Revisa tu correo.");
  } catch(e){
    log("‚ùå Error al enviar c√≥digo: " + e);
  }
}

async function verificarCodigo(){
  const email = document.getElementById("email").value.trim();
  const codigo = document.getElementById("codigo").value.trim();
  if(!email || !codigo){ log("‚ùå Escribe correo y c√≥digo"); return; }

  log("üîÑ Verificando c√≥digo...");

  try{
    const callbackName = "cb" + Date.now();
    window[callbackName] = function(data){
      if(data.existe){
        log("‚úÖ C√≥digo correcto. Link:");
        log(data.link);
      } else {
        log("‚ùå C√≥digo incorrecto o vencido");
      }
      delete window[callbackName];
    };

    const script = document.createElement("script");
    script.src = `${APPS_SCRIPT_URL}?email=${encodeURIComponent(email)}&codigo=${codigo}&callback=${callbackName}`;
    document.body.appendChild(script);
    script.remove();

  } catch(e){
    log("‚ùå Error al verificar c√≥digo: " + e);
  }
}
</script>

</body>
</html>
