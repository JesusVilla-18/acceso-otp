<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Acceso OTP</title>
<style>
body { font-family: Arial; margin:40px; }
input, button { display:block; margin:10px 0; padding:8px; }
#mensaje { margin-top:20px; white-space: pre-line; padding:10px; border:1px solid #ccc; background:#f2f2f2; }
</style>
</head>
<body>

<h2>Acceso con c√≥digo OTP por correo</h2>

<input id="email" placeholder="Escribe tu correo">
<button id="btnEnviar" onclick="enviarCodigo()">Enviar c√≥digo</button>

<input id="codigo" placeholder="Escribe el c√≥digo recibido" disabled>
<button id="btnVerificar" onclick="verificarCodigo()" disabled>Verificar</button>

<p id="mensaje"></p>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwB4LqY84fyboA-F-XvPGAcULplruxRDT6s7ucriDW7hoLV2Q13DVxzb8COeYk-YK8hOw/exec";

function log(msg){
  document.getElementById("mensaje").innerText += msg + "\n";
}

// Funci√≥n para habilitar/deshabilitar input y bot√≥n del c√≥digo
function setCodigoEnabled(enabled){
  document.getElementById("codigo").disabled = !enabled;
  document.getElementById("btnVerificar").disabled = !enabled;
  if(!enabled){
    document.getElementById("codigo").value = "";
  }
}

async function enviarCodigo(){
  const email = document.getElementById("email").value.trim();
  if(!email){ log("‚ùå Escribe tu correo"); return; }

  log("üì§ Enviando c√≥digo por correo...");
  try{
    const resp = await fetch(APPS_SCRIPT_URL + "?email=" + encodeURIComponent(email));
    const data = await resp.json();
    if(data.ok){
      log("‚úÖ C√≥digo enviado al correo: " + email);
      setCodigoEnabled(true); // Habilitamos input y bot√≥n del c√≥digo
    } else {
      log("‚ùå Error: " + data.mensaje);
      setCodigoEnabled(false);
    }
  } catch(e){
    log("‚ùå Error al enviar el c√≥digo: " + e);
    setCodigoEnabled(false);
  }
}

async function verificarCodigo(){
  const email = document.getElementById("email").value.trim();
  const codigo = document.getElementById("codigo").value.trim();
  const mensaje = document.getElementById("mensaje");
  if(!email || !codigo){ 
    log("‚ùå Completa correo y c√≥digo"); 
    return; 
  }

  log("üîÑ Verificando c√≥digo...");
  try{
    const resp = await fetch(APPS_SCRIPT_URL, {
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`email=${encodeURIComponent(email)}&codigo=${encodeURIComponent(codigo)}`
    });
    const data = await resp.json();
    if(data.ok){
      log("‚úÖ C√≥digo correcto");

      // Crear enlace con emoji de ojo y texto
      const linkText = "üëÅÔ∏è Ver recibos";
      const a = document.createElement("a");
      a.href = data.link;
      a.target = "_blank";
      a.innerText = linkText;

      mensaje.appendChild(a);
      mensaje.appendChild(document.createElement("br"));

      // Limpiar inputs y deshabilitar input/bot√≥n del c√≥digo
      setCodigoEnabled(false);
      document.getElementById("email").value = "";
    } else {
      log("‚ùå " + data.mensaje);
      // No hacemos nada: input y bot√≥n siguen habilitados para reintentar
    }
  } catch(e){
    log("‚ùå Error al verificar el c√≥digo: " + e);
    // No hacemos nada: input y bot√≥n siguen habilitados
  }
}

// Al cargar la p√°gina, aseguramos que el c√≥digo est√© deshabilitado
setCodigoEnabled(false);
</script>

</body>
</html>
