<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Acceso con OTP</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    body { font-family: Arial; margin: 40px; }
    input, button { display:block; margin:10px 0; padding:8px; }
    #mensaje { margin-top:20px; }
    #debug {
      background:#f0f0f0;
      padding:10px;
      border:1px solid #ccc;
      font-family:monospace;
      margin-top:20px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h2>Acceso con c√≥digo SMS</h2>

<input id="telefono" placeholder="Escribe tu celular (10 d√≠gitos)">
<button id="enviarCodigo" onclick="enviarCodigo()">Enviar c√≥digo</button>

<br>

<input id="codigo" placeholder="Escribe el c√≥digo recibido">
<button onclick="verificarCodigo()">Verificar</button>

<p id="mensaje"></p>

<h3>üõ†Ô∏è DEPURACI√ìN (importante)</h3>
<div id="debug"></div>

<script>
// ======= FIREBASE =======
const firebaseConfig = {
  apiKey: "AIzaSyCDpJfISRnxCJiG1PERbYDJ3jQdzxKvIlQ",
  authDomain: "acceso-drive-otp.firebaseapp.com",
  projectId: "acceso-drive-otp",
  storageBucket: "acceso-drive-otp.firebasestorage.app",
  messagingSenderId: "175952295726",
  appId: "1:175952295726:web:1e20d679ae42a0106a6cbf",
  measurementId: "G-49P3MFSGC1"
};

firebase.initializeApp(firebaseConfig);

// ======= TU URL DE APPS SCRIPT =======
const APPS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbzUGJnrhOPq6fXje-DmuqJFQk-_aU7wMhmrFOSQBvospoqRPWZB5evC6dGpxvRl9Td5/exec";

// Para JSONP
window.ultimoResultado = null;
function callback(data) {
  window.ultimoResultado = data;
  log("üì• Respuesta Apps Script: " + JSON.stringify(data));
}

// reCAPTCHA invisible
window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('enviarCodigo', {
  'size': 'invisible'
});

let confirmationResult;
let telefonoGlobal = "";

function log(text){
  document.getElementById("debug").innerText += text + "\n";
}

async function enviarCodigo() {
  document.getElementById("debug").innerText = ""; // limpiar logs

  let tel = document.getElementById("telefono").value.trim();

  if (tel.length !== 10 || isNaN(tel)) {
    document.getElementById("mensaje").innerText =
      "Escribe un celular v√°lido de 10 d√≠gitos.";
    return;
  }

  telefonoGlobal = "+52" + tel;      // para Firebase
  const numero52 = "52" + tel;       // para Sheets

  log("üìû Tel√©fono escrito: " + tel);
  log("‚û°Ô∏è Para Firebase: " + telefonoGlobal);
  log("‚û°Ô∏è Para Sheets: " + numero52);

  document.getElementById("mensaje").innerText =
    "Verificando n√∫mero en base de datos...";

  try {
    log("üîÑ Consultando Apps Script...");

    await fetch(
      APPS_SCRIPT_URL +
      "?cel=" + numero52 +
      "&callback=callback"
    );

    // Esperar a que llegue la respuesta (muy importante)
    await new Promise(resolve => setTimeout(resolve, 900));

    const data = window.ultimoResultado;

    if (!data || !data.existe) {
      document.getElementById("mensaje").innerText =
        "‚ùå Tu n√∫mero no est√° autorizado.";
      log("‚ö†Ô∏è Resultado final: NO AUTORIZADO");
      return;
    }

    log("‚úÖ N√∫mero AUTORIZADO seg√∫n Sheets");

    // Mandar OTP por Firebase
    firebase.auth().signInWithPhoneNumber(
      telefonoGlobal,
      window.recaptchaVerifier
    ).then(function (result) {
      confirmationResult = result;
      document.getElementById("mensaje").innerText =
        "üì© C√≥digo enviado por SMS.";
      log("üì© SMS enviado por Firebase");
    });

  } catch (e) {
    document.getElementById("mensaje").innerText =
      "Error al consultar la base de datos.";
    log("‚ùå ERROR: " + e);
  }
}

async function verificarCodigo() {
  let codigo = document.getElementById("codigo").value.trim();

  if (!confirmationResult) {
    document.getElementById("mensaje").innerText =
      "Primero solicita el c√≥digo.";
    return;
  }

  try {
    await confirmationResult.confirm(codigo);
    log("‚úÖ C√≥digo SMS correcto");

    const telParaSheet = telefonoGlobal.replace("+", "");

    log("üîç Buscando link con: " + telParaSheet);

    await fetch(
      APPS_SCRIPT_URL +
      "?cel=" + telParaSheet +
      "&callback=callback"
    );

    await new Promise(resolve => setTimeout(resolve, 900));

    const data = window.ultimoResultado;

    if (!data || !data.existe) {
      document.getElementById("mensaje").innerText =
        "‚ùå N√∫mero no autorizado.";
      return;
    }

    document.getElementById("mensaje").innerHTML =
      "‚úÖ C√≥digo correcto.<br><br>" +
      "Aqu√≠ est√° tu archivo:<br><b>" +
      data.link +
      "</b>";

  } catch (error) {
    document.getElementById("mensaje").innerText =
      "‚ùå C√≥digo incorrecto.";
  }
}
</script>

</body>
</html>
