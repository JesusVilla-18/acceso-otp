<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Acceso con OTP</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    body { font-family: Arial; margin: 40px; }
    input, button { display:block; margin:10px 0; padding:8px; }
    #mensaje {
      margin-top:20px;
      background:#f2f2f2;
      padding:10px;
      white-space: pre-line;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h2>Acceso con c√≥digo SMS</h2>

<input id="telefono" placeholder="Escribe tu celular (10 d√≠gitos)">
<button id="enviarCodigo" onclick="enviarCodigo()">Enviar c√≥digo</button>

<br>

<input id="codigo" placeholder="Escribe el c√≥digo recibido">
<button onclick="verificarCodigo()">Verificar</button>

<h3>Registro de sistema:</h3>
<p id="mensaje"></p>

<script>
// ======= FIREBASE =======
const firebaseConfig = {
  apiKey: "AIzaSyCOxPGwuNYUqE_rmDeawt_x_lsVMNSpx6w",
  authDomain: "acceso-drive-otp-c13fb.firebaseapp.com",
  projectId: "acceso-drive-otp-c13fb",
  storageBucket: "acceso-drive-otp-c13fb.firebasestorage.app",
  messagingSenderId: "620751699211",
  appId: "1:620751699211:web:79811953dfef547664f60e",
  measurementId: "G-CVTNV4G66W"
};

firebase.initializeApp(firebaseConfig);

// ======= APPS SCRIPT =======
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykxvJV31sMMXXF_NoxqVLqqAXtk3KVbyP0zsNogi3KedFQK3hF0EWg312t2AiWC-Qymg/exec";

window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('enviarCodigo', {
  'size': 'invisible'
});

let confirmationResult;
let telefonoGlobal = "";

// Registro en pantalla
function log(msg){
  document.getElementById("mensaje").innerText += "\n" + msg;
}

// JSONP: se ejecuta autom√°ticamente cuando Apps Script responde
function jsonpCallback(data){
  window.jsonpData = data;
}

// Llamada JSONP
function llamarJSONP(numero){
  return new Promise((resolve, reject) => {
    window.jsonpData = null;

    const script = document.createElement('script');
    script.src = `${APPS_SCRIPT_URL}?cel=${numero}&callback=jsonpCallback`;
    script.onerror = () => reject("No se pudo consultar la base de datos");
    document.body.appendChild(script);

    let intentos = 0;
    const interval = setInterval(() => {
      if(window.jsonpData){
        clearInterval(interval);
        document.body.removeChild(script);
        resolve(window.jsonpData);
      } else if(intentos++ > 50){ // timeout ~5s
        clearInterval(interval);
        document.body.removeChild(script);
        reject("Tiempo de espera agotado");
      }
    }, 100);
  });
}

// ==================== FUNCIONES PRINCIPALES ====================
async function enviarCodigo() {
  document.getElementById("mensaje").innerText = "";

  let tel = document.getElementById("telefono").value.trim();
  if(tel.length !== 10 || isNaN(tel)){
    log("‚ùå Escribe un celular v√°lido de 10 d√≠gitos.");
    return;
  }

  telefonoGlobal = "+52" + tel;
  const numeroParaSheet = "52" + tel;

  log("üìû Tel√©fono escrito: " + tel);
  log("‚û°Ô∏è Para Firebase: " + telefonoGlobal);
  log("‚û°Ô∏è Para Sheets: " + numeroParaSheet);
  log("üîÑ Consultando Apps Script...");

  try {
    const data = await llamarJSONP(numeroParaSheet);

    if(!data || !data.existe){
      log("‚ö†Ô∏è Resultado final: NO AUTORIZADO");
      return;
    }

    log("‚úÖ AUTORIZADO ‚Äî enviando SMS...");

    confirmationResult = await firebase.auth()
      .signInWithPhoneNumber(telefonoGlobal, window.recaptchaVerifier);

    log("üì© C√≥digo enviado por SMS.");

  } catch(e){
    console.error(e);
    log("‚ùå ERROR REAL DE SISTEMA:");
    log(e.toString());
  }
}

async function verificarCodigo() {
  let codigo = document.getElementById("codigo").value.trim();
  if(!confirmationResult){
    log("Primero solicita el c√≥digo.");
    return;
  }

  try{
    await confirmationResult.confirm(codigo);

    const telParaSheet = telefonoGlobal.replace("+", "");
    log("üîÅ Reconsultando Sheets con: " + telParaSheet);

    const data = await llamarJSONP(telParaSheet);

    if(!data || !data.existe){
      log("‚ùå N√∫mero no autorizado.");
      return;
    }

    document.getElementById("mensaje").innerHTML +=
      "\n\n‚úÖ C√≥digo correcto.\nüîó Link: " + data.link;

  } catch(error){
    log("‚ùå C√≥digo incorrecto.");
  }
}
</script>

</body>
</html>

