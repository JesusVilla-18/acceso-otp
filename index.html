<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Acceso con OTP por correo</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    input, button { display:block; margin:10px 0; padding:8px; }
    #mensaje { margin-top:20px; background:#f2f2f2; padding:10px; white-space: pre-line; border: 1px solid #ccc; }
  </style>
</head>
<body>

<h2>Acceso con c√≥digo por correo</h2>

<input id="email" placeholder="Escribe tu correo">
<button onclick="enviarCodigo()">Enviar c√≥digo</button>

<br>

<input id="codigo" placeholder="Escribe el c√≥digo recibido">
<button onclick="verificarCodigo()">Verificar</button>

<p id="mensaje"></p>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyFve7wgPN4H4FYcExoP83DkiE09LlFbF9VbOjbJoPE9l8pZqow4KlUFuz7e3ri3rNiQg/exec";

// Variables en memoria
let codigoGenerado = "";
let linkFinal = "";

function log(msg){
  document.getElementById("mensaje").innerText += "\n" + msg;
}

async function enviarCodigo(){
  document.getElementById("mensaje").innerText = "";
  const email = document.getElementById("email").value.trim();

  if(!email.includes("@")){
    log("‚ùå Escribe un correo v√°lido");
    return;
  }

  log("üì§ Enviando c√≥digo por correo...");

  try {
    // Llamamos al Apps Script para generar c√≥digo y enviar email
    const resp = await fetch(`${APPS_SCRIPT_URL}?email=${encodeURIComponent(email)}`);
    const data = await resp.json();

    if(!data.existe){
      log("‚ùå Este correo no est√° autorizado.");
      return;
    }

    codigoGenerado = data.codigo;  // guardamos el c√≥digo generado
    linkFinal = data.link;          // guardamos el link del Sheet
    log(`‚úÖ C√≥digo enviado a ${email}.`);
    log("‚è± C√≥digo v√°lido por 2 minutos.");

    // Caducidad autom√°tica del c√≥digo
    setTimeout(()=> {
      codigoGenerado = "";
      log("‚ö†Ô∏è C√≥digo expirado.");
    }, 120000); // 2 minutos

  } catch(e){
    console.error(e);
    log("‚ùå Error al enviar c√≥digo.");
  }
}

function verificarCodigo(){
  const codigoUsuario = document.getElementById("codigo").value.trim();

  if(codigoUsuario === ""){
    log("‚ùå Escribe el c√≥digo recibido.");
    return;
  }

  if(codigoGenerado === ""){
    log("‚ùå C√≥digo expirado o no solicitado.");
    return;
  }

  if(codigoUsuario === codigoGenerado){
    log("‚úÖ C√≥digo correcto!");
    log("üîó Aqu√≠ est√° tu enlace: " + linkFinal);
    // Limpiamos c√≥digo para que no se use de nuevo
    codigoGenerado = "";
  } else {
    log("‚ùå C√≥digo incorrecto.");
  }
}
</script>

</body>
</html>
