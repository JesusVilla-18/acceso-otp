<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Acceso OTP</title>
<style>
body { font-family: Arial; margin:40px; }
input, button { display:block; margin:10px 0; padding:8px; }
#mensaje { margin-top:20px; white-space: pre-line; padding:10px; border:1px solid #ccc; background:#f2f2f2; }
</style>
</head>
<body>

<h2>Acceso con cÃ³digo OTP por correo</h2>

<input id="email" placeholder="Escribe tu correo">
<button id="btnEnviar" onclick="enviarCodigo()">Enviar cÃ³digo</button>

<input id="codigo" placeholder="Escribe el cÃ³digo recibido" disabled>
<button id="btnVerificar" onclick="verificarCodigo()" disabled>Verificar</button>

<p id="mensaje"></p>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwB4LqY84fyboA-F-XvPGAcULplruxRDT6s7ucriDW7hoLV2Q13DVxzb8COeYk-YK8hOw/exec";

const mensaje = document.getElementById("mensaje");

function log(msg){
  mensaje.innerText += msg + "\n";
}

// Habilitar/deshabilitar input y botÃ³n del cÃ³digo
function setCodigoEnabled(enabled){
  document.getElementById("codigo").disabled = !enabled;
  document.getElementById("btnVerificar").disabled = !enabled;
  if(!enabled){
    document.getElementById("codigo").value = "";
  }
}

async function enviarCodigo(){
  const email = document.getElementById("email").value.trim();
  if(!email){ 
    mensaje.innerText = "âŒ Escribe tu correo\n";
    return; 
  }

  // Limpiamos todo el log y mostramos enviando cÃ³digo
  mensaje.innerText = "ğŸ“¤ Enviando cÃ³digo por correo...\n";

  try{
    const resp = await fetch(APPS_SCRIPT_URL + "?email=" + encodeURIComponent(email));
    const data = await resp.json();
    if(data.ok){
      log("âœ… CÃ³digo enviado al correo: " + email);
      setCodigoEnabled(true);
    } else {
      log("âŒ Error: " + data.mensaje);
      setCodigoEnabled(false);
    }
  } catch(e){
    log("âŒ Error al enviar el cÃ³digo: " + e);
    setCodigoEnabled(false);
  }
}

async function verificarCodigo(){
  const email = document.getElementById("email").value.trim();
  const codigo = document.getElementById("codigo").value.trim();
  if(!email || !codigo){ 
    log("âŒ Completa correo y cÃ³digo"); 
    return; 
  }

  // Guardamos los mensajes previos de envÃ­o de correo
  let logPrevio = mensaje.innerText.split("\n").filter(line => line.startsWith("ğŸ“¤") || line.startsWith("âœ… CÃ³digo enviado")).join("\n");

  // Mostramos "verificando cÃ³digo..."
  mensaje.innerText = logPrevio + "\nğŸ”„ Verificando cÃ³digo...\n";

  try{
    const resp = await fetch(APPS_SCRIPT_URL, {
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`email=${encodeURIComponent(email)}&codigo=${encodeURIComponent(codigo)}`
    });
    const data = await resp.json();

    if(data.ok){
      // Reemplazamos "ğŸ”„ Verificando cÃ³digo..." por âœ… CÃ³digo correcto
      mensaje.innerText = logPrevio + "\nâœ… CÃ³digo correcto\n";

      // Crear enlace con emoji de ojo y texto
      const a = document.createElement("a");
      a.href = data.link;
      a.target = "_blank";
      a.innerText = "ğŸ‘ï¸ Ver recibos";
      mensaje.appendChild(a);
      mensaje.appendChild(document.createElement("br"));

      // Limpiar inputs y deshabilitar input/botÃ³n del cÃ³digo
      setCodigoEnabled(false);
      document.getElementById("email").value = "";

    } else {
      // Reemplazamos "ğŸ”„ Verificando cÃ³digo..." por âŒ CÃ³digo incorrecto
      mensaje.innerText = logPrevio + "\nâŒ " + data.mensaje + "\n";
      // Input y botÃ³n siguen habilitados para reintento
    }
  } catch(e){
    mensaje.innerText = logPrevio + "\nâŒ Error al verificar el cÃ³digo: " + e + "\n";
  }
}

// Al cargar la pÃ¡gina, input y botÃ³n del cÃ³digo deshabilitados
setCodigoEnabled(false);
</script>

</body>
</html>
