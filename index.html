<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Acceso con c√≥digo por correo</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    input, button { display:block; margin:10px 0; padding:8px; }
    #mensaje {
      margin-top:20px;
      background:#f2f2f2;
      padding:10px;
      white-space: pre-line;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h2>Acceso con c√≥digo por correo</h2>

<input id="email" placeholder="Escribe tu correo">
<button onclick="enviarCodigo()">Enviar c√≥digo</button>

<br>

<input id="codigo" placeholder="Escribe el c√≥digo recibido">
<button onclick="verificarCodigo()">Verificar</button>

<h3>Registro de sistema:</h3>
<p id="mensaje"></p>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwSPHv8_DZkTnos7tiPDWny4mya8l2FP95pIr8bGrvskP7pwT7K0EVlC6pievzW7KCbEQ/exec"; // reemplaza con tu URL

let codigoServer = null;
let codigoExpira = null;

function log(msg){
  document.getElementById("mensaje").innerText += "\n" + msg;
}

// Funci√≥n que crea un <script> para JSONP
function enviarCodigo() {
  document.getElementById("mensaje").innerText = "";
  const email = document.getElementById("email").value.trim();
  if(!email){
    log("‚ùå Escribe un correo v√°lido.");
    return;
  }

  log("üì§ Enviando c√≥digo por correo...");

  const script = document.createElement("script");
  script.src = `${APPS_SCRIPT_URL}?email=${encodeURIComponent(email)}&callback=callback`;
  document.body.appendChild(script);
}

// Callback JSONP desde Apps Script
function callback(data){
  if(data.success){
    codigoServer = data.codigo;
    codigoExpira = Date.now() + 2*60*1000; // 2 minutos
    log("‚úÖ C√≥digo enviado. Expira en 2 minutos.");
    log("üì© Revisa tu correo.");
  } else {
    log("‚ùå Error al enviar el c√≥digo.");
  }
}

// Verifica el c√≥digo ingresado por el usuario
function verificarCodigo(){
  const codigoUsuario = document.getElementById("codigo").value.trim();
  if(!codigoServer){
    log("‚ùå Primero solicita un c√≥digo.");
    return;
  }
  if(Date.now() > codigoExpira){
    log("‚ùå El c√≥digo ha expirado. Solicita uno nuevo.");
    codigoServer = null;
    return;
  }
  if(codigoUsuario === String(codigoServer)){
    log("‚úÖ C√≥digo correcto. Acceso permitido.");
  } else {
    log("‚ùå C√≥digo incorrecto.");
  }
}
</script>

</body>
</html>

